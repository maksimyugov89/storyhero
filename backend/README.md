# StoryHero Backend

Backend-часть приложения StoryHero, отвечающая за генерацию персонализированных детских книг, управление пользователями, обработку изображений и создание PDF.

## Архитектура

Проект построен на FastAPI (Python 3.11) с использованием PostgreSQL в качестве основной базы данных. Приложение следует классической многослойной архитектуре:

- **Модели данных** (SQLAlchemy ORM)
- **Схемы** (Pydantic для валидации)
- **Роутеры** (FastAPI endpoints)
- **Сервисы** (бизнес-логика)
- **Утилиты и скрипты** (вспомогательные задачи)

## Структура директорий

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # Точка входа FastAPI
│   ├── db.py                # Настройка базы данных
│   ├── models/              # SQLAlchemy модели
│   │   ├── book.py          # Модель книги
│   │   ├── child.py         # Модель ребёнка (с полем gender)
│   │   ├── child_face_profile.py  # Face profile ребёнка (embeddings)
│   │   ├── scene.py         # Модель сцены
│   │   ├── image.py         # Модель изображения
│   │   ├── user.py          # Модель пользователя
│   │   ├── subscription.py  # Модель подписки
│   │   ├── print_order.py   # Модель заказа на печать
│   │   ├── task.py          # Модель задачи генерации
│   │   ├── support_message.py  # Модель сообщений поддержки
│   │   └── ...
│   ├── schemas/             # Pydantic схемы
│   │   ├── face_profile.py  # Схемы для face profile
│   │   └── ...
│   ├── routers/             # FastAPI роутеры
│   │   ├── auth.py          # Аутентификация
│   │   ├── auth_info.py     # Информация о пользователе
│   │   ├── books.py         # Управление книгами (CRUD, удаление через raw SQL)
│   │   ├── books_workflow.py # Workflow генерации книг
│   │   ├── book_editing.py  # Редактирование книг
│   │   ├── children.py      # Управление детьми
│   │   ├── images.py        # Управление изображениями
│   │   ├── image_prompts.py # Промпты для изображений
│   │   ├── final_images.py  # Финальные изображения
│   │   ├── plot.py          # Генерация сюжета
│   │   ├── text.py          # Генерация текста
│   │   ├── style.py         # Стили иллюстраций
│   │   ├── profile.py       # Профиль пользователя
│   │   ├── upload.py        # Загрузка файлов
│   │   ├── payments.py      # Платежи
│   │   ├── orders.py        # Заказы на печать
│   │   ├── subscription.py # Подписки
│   │   ├── support.py      # Сообщения поддержки
│   │   ├── test_notifications.py  # Тестовые уведомления
│   │   └── ...
│   ├── services/            # Бизнес-логика
│   │   ├── tasks.py         # Управление асинхронными задачами
│   │   ├── gemini_service.py # Генерация текста через Gemini API
│   │   ├── llm.py           # Общие функции для LLM
│   │   ├── pollinations_service.py  # Генерация изображений через Pollinations.ai
│   │   ├── pollinations_img2img_service.py  # Img2img через Pollinations
│   │   ├── fal_service.py   # Генерация изображений через FAL (резерв)
│   │   ├── face_service.py  # Работа с лицами (embeddings, распознавание)
│   │   ├── face_swap_service.py  # Замена лиц на изображениях
│   │   ├── image_pipeline.py  # Пайплайн генерации изображений
│   │   ├── image_fetcher.py  # Загрузка изображений из внешних источников
│   │   ├── pdf_service.py   # Создание PDF книг
│   │   ├── storage.py       # Хранение файлов
│   │   ├── local_file_service.py  # Работа с локальными файлами
│   │   ├── subscription_service.py  # Логика подписок
│   │   ├── cleanup_service.py  # Очистка старых данных
│   │   ├── email_service.py  # Отправка email
│   │   ├── cover_title_service.py  # Генерация обложек и заголовков
│   │   ├── skin_tone_service.py  # Анализ тона кожи для печати
│   │   ├── prompt_sanitizer.py  # Очистка и валидация промптов
│   │   ├── scene_utils.py   # Утилиты для работы со сценами
│   │   ├── style_prompts.py  # Генерация промптов для стилей
│   │   ├── cmyk_presets.py  # CMYK пресеты для печати
│   │   └── ...
│   ├── print/               # Логика печати
│   │   ├── color_pipeline.py  # Цветовой пайплайн для печати
│   │   ├── print_config.py  # Конфигурация печати
│   │   └── skin_tone_safe.py  # Безопасные цвета для тона кожи
│   ├── config/              # Конфигурация
│   │   ├── env.example      # Пример переменных окружения
│   │   ├── pricing.py       # Цены на печать
│   │   └── styles.py         # Стили иллюстраций
│   ├── core/                # Ядро приложения
│   │   ├── deps.py          # Зависимости FastAPI
│   │   └── security.py      # Аутентификация и авторизация
│   ├── auth/                # Аутентификация (legacy)
│   ├── scripts/             # Скрипты для администрирования
│   │   ├── generate_pdf_for_book.py
│   │   ├── generate_final_images_for_book.py
│   │   ├── monitor_book_generation.py
│   │   ├── test_face_profile.py
│   │   └── ...
│   └── assets/              # Статические ресурсы
│       └── fonts/           # Шрифты (DejaVuSans.ttf)
├── migrations/              # Миграции базы данных
│   ├── 001_create_books_table.sql
│   ├── 002_create_editing_tables.sql
│   ├── 003_create_books_table_compatible.sql
│   ├── 004_add_workflow_fields_to_books.sql
│   ├── 005_create_support_tables.sql
│   ├── 006_add_gender_to_children.sql
│   └── ...
├── models_insightface/      # Модели для распознавания лиц
├── scripts/                 # Глобальные скрипты
│   └── setup_telegram_webhook.py
├── Dockerfile
├── requirements.txt
└── README.md
```

## Ключевые возможности

### 1. Генерация книг
- **Полный цикл генерации**: от идеи до готового PDF
- **Асинхронные задачи**: генерация через систему задач (Task model)
- **Workflow состояний**: draft → editing → finalization → paid
- **Генерация текста**: через Gemini API
- **Генерация изображений**: через Pollinations.ai (основной) и FAL (резерв)
- **Face swap**: замена лиц на изображениях с использованием face profiles
- **Создание PDF**: автоматическая генерация PDF с обложкой

### 2. Управление книгами
- **CRUD операции**: создание, чтение, обновление, удаление
- **Безопасное удаление**: удаление через raw SQL для избежания проблем с каскадными связями
- **Фильтрация**: по статусу, типу, дате создания
- **Редактирование**: версии текста и изображений
- **История изменений**: отслеживание edit_history

### 3. Управление детьми
- **Профили детей**: имя, возраст, пол (gender)
- **Face profiles**: хранение embeddings лиц для персонализации
- **Фотографии**: загрузка и управление фотографиями детей
- **Связь с книгами**: каждый ребёнок может иметь множество книг

### 4. Генерация изображений
- **Pollinations.ai**: основной сервис для генерации изображений
- **Img2img**: преобразование существующих изображений
- **Face swap**: замена лиц с использованием InsightFace
- **Стили иллюстраций**: поддержка различных стилей (включая premium)
- **Промпты**: автоматическая генерация и валидация промптов
- **Fallback**: автоматический переход на резервные сервисы при ошибках

### 5. Печать книг
- **Заказы на печать**: создание и управление заказами
- **CMYK конвертация**: подготовка изображений для печати
- **Цветовой пайплайн**: обработка цветов с учётом тона кожи
- **Безопасные цвета**: автоматическая коррекция для печати

### 6. Подписки и платежи
- **Подписки**: управление подписками пользователей
- **Платежи**: интеграция с платёжными системами
- **Проверка доступа**: контроль доступа к premium функциям
- **Автоматическая проверка**: проверка истечения подписок

### 7. Поддержка
- **Сообщения поддержки**: система обратной связи от пользователей
- **Типы сообщений**: предложения, баги, вопросы
- **Ответы**: возможность ответов на сообщения
- **Статусы**: отслеживание статусов сообщений (new, answered, closed)

### 8. Асинхронные задачи
- **Task model**: модель для отслеживания задач генерации
- **Прогресс**: детальный прогресс выполнения задач
- **Статусы**: pending, running, success, error
- **Метаданные**: хранение метаданных для проверки дубликатов

## Технологии

- **FastAPI**: веб-фреймворк
- **PostgreSQL**: база данных
- **SQLAlchemy**: ORM
- **Pydantic**: валидация данных
- **Gemini API**: генерация текста
- **Pollinations.ai**: генерация изображений
- **FAL**: резервный сервис генерации изображений
- **InsightFace**: распознавание и работа с лицами
- **ReportLab/Pillow**: создание PDF и обработка изображений

## Переменные окружения

Основные переменные окружения (см. `app/config/env.example`):

- `SECRET_KEY`: секретный ключ для JWT
- `GEMINI_API_KEY`: API ключ для Gemini
- `DATABASE_URL`: URL подключения к PostgreSQL
- `BASE_UPLOAD_DIR`: директория для загрузки файлов
- И другие (см. `env.example`)

## Миграции базы данных

Миграции находятся в директории `migrations/`:

- `005_create_support_tables.sql`: создание таблиц для поддержки
- `006_add_gender_to_children.sql`: добавление поля gender в таблицу children

## Важные особенности

### Удаление книг
Удаление книг реализовано через raw SQL для избежания проблем с каскадными связями в SQLAlchemy. Все связанные данные (print_orders, images, theme_styles, scenes) удаляются в одной транзакции.

### Face Profiles
Система face profiles позволяет хранить embeddings лиц детей для последующей замены на изображениях. Используется InsightFace для генерации embeddings.

### Асинхронная генерация
Генерация книг выполняется асинхронно через систему задач. Пользователь может отслеживать прогресс через API endpoint `/books/task_status/{task_id}`.

## API Endpoints

Основные группы endpoints (с префиксом `/api/v1`):

- `/auth/*` - аутентификация
- `/books/*` - управление книгами
- `/children/*` - управление детьми
- `/images/*` - управление изображениями
- `/payments/*` - платежи
- `/orders/*` - заказы на печать
- `/subscription/*` - подписки
- `/support/*` - сообщения поддержки

Полная документация доступна через Swagger UI: `/docs`

## Разработка

### Запуск локально

```bash
cd backend
pip install -r requirements.txt
uvicorn app.main:app --reload
```

### Docker

```bash
docker-compose up backend
```

## Лицензия

Proprietary - StoryHero
